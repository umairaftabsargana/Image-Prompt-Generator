<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cinematic Image Prompt Generator</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles for Tailwind Configuration -->
    <style>
        body {
            background-color: #111827; /* gray-900 */
            color: white;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useCallback, useRef } = React;

        // --- ICONS (Inline replacements for lucide-react) ---
        const Film = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg>);
        const Aperture = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m14.31 8 5.74 9.94"/><path d="M9.69 8h11.48"/><path d="m7.38 12 5.74-9.94"/><path d="M9.69 16 3.95 6.06"/><path d="M14.31 16H2.83"/><path d="m16.62 12-5.74 9.94"/></svg>);
        const Zap = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>);
        const CheckCircle = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>);
        const Send = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>);
        const Loader = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>);
        const Trash2 = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>);
        const Upload = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>);
        const X = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>);

        // --- CONFIG ---
        const API_KEY = "AIzaSyDow7HCvkb2B-pNhunGpCa0aUN2lCPH9QY"; // üö® API KEY ADDED HERE üö®
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

        const STYLE_OPTIONS = [
            { value: 'Cinematic', label: 'Cinematic', icon: <Film className="w-5 h-5" /> },
            { value: 'Realistic', label: 'Realistic', icon: <Aperture className="w-5 h-5" /> },
            { value: 'Stylized Animation', label: 'Stylized Animation', icon: <Zap className="w-5 h-5" /> },
        ];

        const PROMPT_TEMPLATE = `
IMAGE PROMPT TEMPLATE (Use this exact structure for every scene):
Scene {NUMBER}
Style: {Style}
Create a highly detailed scene showing:
‚Äú{SCENE DESCRIPTION}‚Äù
Visual Tone: dramatic, immersive, atmospheric
Camera: choose best (wide shot, close-up, mid-shot, aerial, POV)
Colors: vivid, balanced, film-like palette
Lighting: cinematic lighting, volumetric depth, soft shadows
Quality: ultra-realistic, 8K, sharp focus, high detail
Consistency: match all elements to provided reference images
Inspiration: {Inspiration (Include 'Pixar + DreamWorks + Ghibli' only if Style is 'Stylized Animation')}
Rules:
No text, no subtitles, no watermarks.
`;

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [step, setStep] = useState('input'); // 'input', 'confirmation', 'generating', 'output'
            const [script, setScript] = useState('');
            const [style, setStyle] = useState('Cinematic');
            const [referenceImages, setReferenceImages] = useState([]); 
            const [customSceneCount, setCustomSceneCount] = useState('');
            const [recommendedScenes, setRecommendedScenes] = useState(0);
            const [finalSceneCount, setFinalSceneCount] = useState(0);
            const [imagePrompts, setImagePrompts] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const fileInputRef = useRef(null);

            const scriptWordCount = useMemo(() => {
                if (!script) return 0;
                // Supports English and other languages
                return script.trim().split(/\s+/).filter(word => word.length > 0).length;
            }, [script]);

            // Handle Image Upload and Conversion to Base64
            const handleImageUpload = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                if (referenceImages.length + files.length > 3) {
                    setError("Only a maximum of 3 (three) reference images are allowed.");
                    return;
                }

                const newImages = [];
                let processed = 0;

                files.forEach(file => {
                    if (!file.type.startsWith('image/')) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64String = event.target.result.split(',')[1];
                        newImages.push({
                            id: Math.random().toString(36).substr(2, 9),
                            data: base64String,
                            mimeType: file.type,
                            preview: event.target.result
                        });
                        processed++;
                        if (processed === files.length) {
                            setReferenceImages(prev => [...prev, ...newImages]);
                            setError(null);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            };

            const removeImage = (id) => {
                setReferenceImages(prev => prev.filter(img => img.id !== id));
            };

            // Step 1: Analyze Script and Recommend Scenes
            const analyzeScript = useCallback(() => {
                if (scriptWordCount === 0 || !style) {
                    setError('Please paste your script and select a style.');
                    return;
                }
                // Recommendation logic: 1 scene per 100 words, minimum 3, max 20 for initial suggestion
                const recommended = Math.min(20, Math.max(3, Math.ceil(scriptWordCount / 100)));
                setRecommendedScenes(recommended);
                setCustomSceneCount(recommended.toString());
                setStep('confirmation');
                setError(null);
            }, [scriptWordCount, style]);

            // Step 2: Confirmation and Finalize Scene Count
            const confirmSceneCount = useCallback(() => {
                const count = parseInt(customSceneCount, 10);
                if (isNaN(count) || count < 1) {
                    setError('Please enter a valid number of scenes (at least 1).');
                    return;
                }
                setFinalSceneCount(count);
                generateScenePrompts(count);
                setError(null);
            }, [customSceneCount]);

            // Step 3: Scene Generation (Multimodal API Call)
            const generateScenePrompts = useCallback(async (count) => {
                // STRONG API KEY CHECK
                if (!API_KEY || API_KEY.trim() === "") {
                    setError("üö® API Key missing! Please ensure you enter your Google Gemini API Key at the top of the code file.");
                    setIsLoading(false); 
                    setStep('confirmation'); 
                    return;
                }

                setIsLoading(true);
                setStep('generating');
                setError(null);

                const systemInstruction = `You are an Ultra-Cinematic Scene Prompt Generator. Your task is to act as a visual translator. Convert the provided story script into exactly ${count} visually rich, emotionally strong, detailed, and story-accurate IMAGE PROMPTS. 

                The full output must be a single, clean block containing ${count} generated prompts text. Do not include any introductory or concluding text, only the generated prompts.
                
                The script analysis and prompt generation must strictly follow the user-provided template and rules for consistency, camera angles, lighting, and quality.`;

                const textPrompt = `
                Analyze the following script and break it down into exactly ${count} distinct scenes.
                For each scene, write a highly detailed IMAGE PROMPT.
                
                Story Script:
                ---
                ${script}
                ---
                
                Style Chosen: ${style}
                
                ${referenceImages.length > 0 ? "IMPORTANT: Use the attached images as strict visual references for character design, environment style, and color palette in the prompts." : ""}
                
                Use the following exact template for your output. For 'Inspiration', only include 'Pixar + DreamWorks + Ghibli' if the Style is 'Stylized Animation'.
                
                ${PROMPT_TEMPLATE}
                `;

                // Construct Multimodal Payload
                const contentParts = [{ text: textPrompt }];
                
                // Add images to payload if they exist
                referenceImages.forEach(img => {
                    contentParts.push({
                        inlineData: {
                            mimeType: img.mimeType,
                            data: img.data
                        }
                    });
                });

                // Exponential Backoff Logic for retries
                let attempts = 0;
                const maxAttempts = 5;

                while (attempts < maxAttempts) {
                    try {
                        const payload = {
                            contents: [{ role: "user", parts: contentParts }],
                            systemInstruction: {
                                parts: [{ text: systemInstruction }]
                            },
                        };

                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            // Throw error with status to be caught below
                            const errorBody = await response.text();
                            throw new Error(`HTTP error! status: ${response.status}. Details: ${errorBody.substring(0, 100)}...`);
                        }

                        const result = await response.json();
                        const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (generatedText) {
                            setImagePrompts(generatedText);
                            setStep('output');
                            setIsLoading(false);
                            return;
                        } else {
                            throw new Error("Model response was empty or malformed.");
                        }

                    } catch (e) {
                        attempts++;
                        if (attempts >= maxAttempts) {
                            console.error("Final generation failure:", e);
                            setError(`üö® Failed to generate prompts. Ensure your API Key is correct. Error: ${e.message}`);
                            setIsLoading(false);
                            setStep('confirmation');
                            return;
                        }
                        // Retry logic
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }, [script, style, referenceImages]);


            // Helper component for style selection
            const StyleSelector = ({ selectedStyle, onSelect }) => (
                <div className="flex space-x-4">
                    {STYLE_OPTIONS.map((opt) => (
                        <button
                            key={opt.value}
                            onClick={() => onSelect(opt.value)}
                            className={`
                                flex flex-col items-center justify-center p-4 rounded-xl transition-all duration-200
                                w-1/3 text-sm font-semibold shadow-lg
                                ${selectedStyle === opt.value
                                    ? 'bg-indigo-600 text-white ring-4 ring-indigo-400/50'
                                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white'
                                }
                            `}
                        >
                            {opt.icon}
                            <span className="mt-2 text-center">{opt.label}</span>
                        </button>
                    ))}
                </div>
            );

            // Helper component to display output
            const OutputBlock = () => (
                <div className="bg-gray-800 p-6 rounded-xl shadow-2xl space-y-4">
                    <h2 className="text-xl font-bold text-indigo-400 flex items-center">
                        <CheckCircle className="w-6 h-6 mr-2" />
                        {finalSceneCount} Image Prompts Ready!
                    </h2>
                    <p className="text-gray-400">
                        These detailed prompts are perfectly suited for Midjourney, Stable Diffusion, or Dall-E.
                    </p>
                    <div className="relative">
                        <pre className="whitespace-pre-wrap font-mono text-sm p-4 bg-black rounded-lg text-green-300 max-h-[60vh] overflow-y-auto border border-gray-700">
                            {imagePrompts}
                        </pre>
                        <button
                            onClick={() => {
                                // Fallback for clipboard API in some environments
                                if (document.execCommand) {
                                    const tempElement = document.createElement('textarea');
                                    tempElement.value = imagePrompts;
                                    document.body.appendChild(tempElement);
                                    tempElement.select();
                                    document.execCommand('copy');
                                    document.body.removeChild(tempElement);
                                    alert('All Prompts Copied!');
                                } else {
                                    navigator.clipboard.writeText(imagePrompts)
                                        .then(() => alert('All Prompts Copied!'))
                                        .catch(() => alert('Failed to copy. Please select and copy manually.'));
                                }
                            }}
                            className="absolute top-2 right-2 p-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full text-xs transition-colors"
                        >
                            Copy All
                        </button>
                    </div>
                    <button
                        onClick={() => setStep('input')}
                        className="w-full mt-4 flex items-center justify-center py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors"
                    >
                        Start New Generation
                    </button>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-900 text-white p-4 sm:p-8 font-sans">
                    <header className="text-center mb-10">
                        <h1 className="text-4xl font-extrabold text-indigo-400 tracking-tight">
                            AI Cinematic Image Prompt Generator
                        </h1>
                        <p className="text-gray-400 mt-2">
                            Script analysis, scene breakdown, and generating the best prompts.
                        </p>
                    </header>

                    <main className="max-w-4xl mx-auto">
                        {error && (
                            <div className="p-4 mb-4 bg-red-800 rounded-lg text-red-200 border border-red-600 font-semibold">
                                ‚ùå Error: {error}
                            </div>
                        )}

                        {/* --- STEP 1: INPUT --- */}
                        {step === 'input' && (
                            <div className="bg-gray-800 p-6 rounded-xl shadow-2xl space-y-6">
                                <h2 className="text-2xl font-semibold text-gray-200">1. Choose Script and Style</h2>
                                <p className="text-gray-400">
                                    Please paste your full script (no word limit), select a visual style, and upload optional reference images.
                                </p>

                                <label className="block text-sm font-medium text-gray-300">Full Script</label>
                                <textarea
                                    value={script}
                                    onChange={(e) => setScript(e.target.value)}
                                    placeholder="Paste your story or script here..."
                                    rows="8"
                                    className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500"
                                ></textarea>
                                <p className="text-xs text-gray-500 text-right">Words: {scriptWordCount}</p>

                                <label className="block text-sm font-medium text-gray-300">Select Scene Style</label>
                                <StyleSelector selectedStyle={style} onSelect={setStyle} />

                                <div className="space-y-2">
                                    <label className="block text-sm font-medium text-gray-300">
                                        Optional Reference Images (Upload for consistency)
                                    </label>
                                    
                                    <div className="flex flex-wrap gap-4">
                                         {/* Upload Button */}
                                        <div 
                                            onClick={() => fileInputRef.current.click()}
                                            className="w-24 h-24 flex flex-col items-center justify-center bg-gray-700 hover:bg-gray-600 border-2 border-dashed border-gray-500 rounded-lg cursor-pointer transition-colors"
                                        >
                                            <Upload className="w-6 h-6 text-gray-400 mb-1" />
                                            <span className="text-xs text-gray-400">Upload</span>
                                        </div>
                                        <input 
                                            type="file" 
                                            multiple 
                                            accept="image/*" 
                                            ref={fileInputRef} 
                                            className="hidden" 
                                            onChange={handleImageUpload}
                                        />

                                        {/* Thumbnails */}
                                        {referenceImages.map((img) => (
                                            <div key={img.id} className="relative w-24 h-24 group">
                                                <img src={img.preview} alt="Reference" className="w-full h-full object-cover rounded-lg border border-gray-600" />
                                                <button 
                                                    onClick={() => removeImage(img.id)}
                                                    className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-colors"
                                                >
                                                    <X className="w-3 h-3" />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                    <p className="text-xs text-gray-500">Maximum 3 images. The AI will analyze them for consistency.</p>
                                </div>

                                <button
                                    onClick={analyzeScript}
                                    disabled={scriptWordCount === 0 || !style}
                                    className={`w-full flex items-center justify-center py-3 px-4 rounded-lg text-lg font-bold transition-all duration-200 ${
                                        scriptWordCount > 0 && style
                                            ? 'bg-indigo-600 hover:bg-indigo-700 shadow-xl shadow-indigo-600/30'
                                            : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                                    }`}
                                >
                                    Analyze Script & Recommend Prompts
                                    <Send className="w-5 h-5 ml-2" />
                                </button>
                            </div>
                        )}

                        {/* --- STEP 2: CONFIRMATION --- */}
                        {step === 'confirmation' && (
                            <div className="bg-gray-800 p-6 rounded-xl shadow-2xl space-y-6">
                                <h2 className="text-2xl font-semibold text-gray-200">2. Confirm Scene Count</h2>
                                <div className="p-4 bg-indigo-900/50 rounded-lg border-l-4 border-indigo-400">
                                    <p className="text-lg font-medium text-indigo-200">
                                        <span className="font-bold">Recommendation:</span> For your {scriptWordCount}-word script, {recommendedScenes} prompts are recommended.
                                    </p>
                                </div>

                                <p className="text-gray-400">
                                    Do you want the recommended count, or would you like to enter a different number?
                                </p>

                                <div className="flex gap-4 items-center">
                                    <input
                                        type="number"
                                        value={customSceneCount}
                                        onChange={(e) => setCustomSceneCount(e.target.value)}
                                        min="1"
                                        className="w-24 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white text-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    />
                                    <span className="text-gray-300 text-lg">Total Scenes / Prompts</span>
                                </div>

                                <div className="flex gap-4">
                                    <button
                                        onClick={confirmSceneCount}
                                        className="flex-1 flex items-center justify-center py-3 px-4 rounded-lg text-lg font-bold bg-indigo-600 hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-600/30"
                                    >
                                        <CheckCircle className="w-5 h-5 mr-2" />
                                        Confirm & Generate Prompts
                                    </button>
                                    <button
                                        onClick={() => setStep('input')}
                                        className="flex-1 flex items-center justify-center py-3 px-4 rounded-lg text-lg font-bold bg-gray-600 hover:bg-gray-500 transition-colors"
                                    >
                                        <Trash2 className="w-5 h-5 mr-2" />
                                        Edit Script / Style
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* --- STEP 3: GENERATING --- */}
                        {step === 'generating' && (
                            <div className="bg-gray-800 p-10 rounded-xl shadow-2xl text-center">
                                <Loader className="w-12 h-12 text-indigo-400 mx-auto animate-spin-slow" />
                                <h2 className="text-2xl font-semibold mt-4 text-gray-200">Generating Cinematic Prompts...</h2>
                                <p className="text-gray-400 mt-2">
                                    The AI is analyzing the script and generating {finalSceneCount} consistent visual prompts ({style} mode). Please wait.
                                </p>
                            </div>
                        )}

                        {/* --- STEP 4: OUTPUT --- */}
                        {step === 'output' && <OutputBlock />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>